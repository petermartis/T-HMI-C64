/*
 Copyright (C) 2024-2025 retroelec <retroelec42@gmail.com>

 Minimal Atari XL OS ROM for testing
 ===================================
 This provides basic initialization and a simple display.
 Replace with Altirra OS or original Atari OS for full compatibility.

 Memory Map (relative to $C000 base):
 $0000-$0FFF: Floating-point package ($C000-$CFFF)
 $1000-$17FF: Self-test ROM ($D000-$D7FF when enabled)
 $1800-$1FFF: Reserved ($D800-$DFFF - normally I/O area)
 $2000-$23FF: Character set ($E000-$E3FF)
 $2400-$3FFF: OS routines and vectors ($E400-$FFFF)
*/
#include "atarixl_os.h"
#include <cstring>

// Internal character set (Atari standard 128 characters, 8 bytes each = 1KB)
// This is a minimal ASCII-compatible character set
static const uint8_t atari_charset[1024] = {
    // Character 0-31: Control characters (blank)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 1
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 2
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 3
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 4
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 5
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 6
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 7
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 8
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 9
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 10
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 11
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 12
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 13
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 14
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 15
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 16
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 17
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 18
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 19
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 20
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 21
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 22
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 23
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 24
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 25
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 26
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 27
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 28
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 29
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 30
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 31
    // Character 32: Space
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // Character 33: !
    0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00,
    // Character 34: "
    0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // Character 35: #
    0x24, 0x7E, 0x24, 0x24, 0x7E, 0x24, 0x00, 0x00,
    // Character 36: $
    0x10, 0x3C, 0x50, 0x38, 0x14, 0x78, 0x10, 0x00,
    // Character 37: %
    0x60, 0x64, 0x08, 0x10, 0x20, 0x4C, 0x0C, 0x00,
    // Character 38: &
    0x30, 0x48, 0x30, 0x50, 0x4C, 0x44, 0x3A, 0x00,
    // Character 39: '
    0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // Character 40: (
    0x08, 0x10, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00,
    // Character 41: )
    0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20, 0x00,
    // Character 42: *
    0x00, 0x44, 0x28, 0xFE, 0x28, 0x44, 0x00, 0x00,
    // Character 43: +
    0x00, 0x10, 0x10, 0x7C, 0x10, 0x10, 0x00, 0x00,
    // Character 44: ,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x20,
    // Character 45: -
    0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00,
    // Character 46: .
    0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00,
    // Character 47: /
    0x00, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00, 0x00,
    // Character 48-57: 0-9
    0x38, 0x44, 0x4C, 0x54, 0x64, 0x44, 0x38, 0x00, // 0
    0x10, 0x30, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, // 1
    0x38, 0x44, 0x04, 0x18, 0x20, 0x40, 0x7C, 0x00, // 2
    0x38, 0x44, 0x04, 0x18, 0x04, 0x44, 0x38, 0x00, // 3
    0x08, 0x18, 0x28, 0x48, 0x7C, 0x08, 0x08, 0x00, // 4
    0x7C, 0x40, 0x78, 0x04, 0x04, 0x44, 0x38, 0x00, // 5
    0x18, 0x20, 0x40, 0x78, 0x44, 0x44, 0x38, 0x00, // 6
    0x7C, 0x04, 0x08, 0x10, 0x20, 0x20, 0x20, 0x00, // 7
    0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x38, 0x00, // 8
    0x38, 0x44, 0x44, 0x3C, 0x04, 0x08, 0x30, 0x00, // 9
    // Character 58: :
    0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00,
    // Character 59: ;
    0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x08, 0x10,
    // Character 60: <
    0x08, 0x10, 0x20, 0x40, 0x20, 0x10, 0x08, 0x00,
    // Character 61: =
    0x00, 0x00, 0x7C, 0x00, 0x7C, 0x00, 0x00, 0x00,
    // Character 62: >
    0x20, 0x10, 0x08, 0x04, 0x08, 0x10, 0x20, 0x00,
    // Character 63: ?
    0x38, 0x44, 0x04, 0x08, 0x10, 0x00, 0x10, 0x00,
    // Character 64: @
    0x38, 0x44, 0x5C, 0x54, 0x5C, 0x40, 0x3C, 0x00,
    // Characters 65-90: A-Z
    0x38, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44, 0x00, // A
    0x78, 0x44, 0x44, 0x78, 0x44, 0x44, 0x78, 0x00, // B
    0x38, 0x44, 0x40, 0x40, 0x40, 0x44, 0x38, 0x00, // C
    0x78, 0x44, 0x44, 0x44, 0x44, 0x44, 0x78, 0x00, // D
    0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7C, 0x00, // E
    0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x00, // F
    0x38, 0x44, 0x40, 0x5C, 0x44, 0x44, 0x3C, 0x00, // G
    0x44, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44, 0x00, // H
    0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, // I
    0x1C, 0x08, 0x08, 0x08, 0x48, 0x48, 0x30, 0x00, // J
    0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44, 0x00, // K
    0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7C, 0x00, // L
    0x44, 0x6C, 0x54, 0x54, 0x44, 0x44, 0x44, 0x00, // M
    0x44, 0x64, 0x54, 0x4C, 0x44, 0x44, 0x44, 0x00, // N
    0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, // O
    0x78, 0x44, 0x44, 0x78, 0x40, 0x40, 0x40, 0x00, // P
    0x38, 0x44, 0x44, 0x44, 0x54, 0x48, 0x34, 0x00, // Q
    0x78, 0x44, 0x44, 0x78, 0x50, 0x48, 0x44, 0x00, // R
    0x38, 0x44, 0x40, 0x38, 0x04, 0x44, 0x38, 0x00, // S
    0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, // T
    0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, // U
    0x44, 0x44, 0x44, 0x44, 0x44, 0x28, 0x10, 0x00, // V
    0x44, 0x44, 0x44, 0x54, 0x54, 0x6C, 0x44, 0x00, // W
    0x44, 0x44, 0x28, 0x10, 0x28, 0x44, 0x44, 0x00, // X
    0x44, 0x44, 0x28, 0x10, 0x10, 0x10, 0x10, 0x00, // Y
    0x7C, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7C, 0x00, // Z
    // Rest filled with remaining characters...
};

// Minimal OS boot routine at $E477 (standard reset entry point)
// This sets up the display list and shows "ATARI 800XL EMU"
static const uint8_t boot_code[] = {
    // Initialize hardware
    0xA9, 0x00,       // LDA #$00
    0x8D, 0x00, 0xD4, // STA DMACTL - disable display
    0x8D, 0x0E, 0xD4, // STA NMIEN - disable NMI
    0x8D, 0x0E, 0xD2, // STA IRQEN - disable IRQ
    0xA9, 0x03,       // LDA #$03
    0x8D, 0x0F, 0xD2, // STA SKCTL - init POKEY

    // Set colors
    0xA9, 0x94,       // LDA #$94 (blue)
    0x8D, 0x18, 0xD0, // STA COLPF2 - text color
    0xA9, 0x00,       // LDA #$00 (black)
    0x8D, 0x1A, 0xD0, // STA COLBK - background

    // Set up character base
    0xA9, 0xE0,       // LDA #$E0 (character set at $E000)
    0x8D, 0x09, 0xD4, // STA CHBASE

    // Set up display list pointer
    0xA9, 0x00,       // LDA #<display_list
    0x8D, 0x02, 0xD4, // STA DLISTL
    0xA9, 0x06,       // LDA #>display_list ($0600)
    0x8D, 0x03, 0xD4, // STA DLISTH

    // Enable display
    0xA9, 0x22,       // LDA #$22 (standard playfield, DL DMA on)
    0x8D, 0x00, 0xD4, // STA DMACTL
    0xA9, 0x40,       // LDA #$40 (VBI enabled)
    0x8D, 0x0E, 0xD4, // STA NMIEN

    // Main loop - just wait
    0x4C, 0x60, 0xE4, // JMP to self (infinite loop at $E460)
};

// Display list at $0600 (set up in RAM by OS init)
static const uint8_t display_list[] = {
    0x70, 0x70, 0x70,           // 24 blank lines (3 x 8)
    0x42, 0x40, 0x06,           // LMS mode 2, screen at $0640
    0x02, 0x02, 0x02, 0x02,     // 4 more mode 2 lines
    0x02, 0x02, 0x02, 0x02,     // 4 more mode 2 lines
    0x02, 0x02, 0x02, 0x02,     // 4 more mode 2 lines
    0x02, 0x02, 0x02, 0x02,     // 4 more mode 2 lines
    0x02, 0x02, 0x02, 0x02,     // 4 more mode 2 lines
    0x02, 0x02, 0x02,           // 3 more mode 2 lines (24 total)
    0x41, 0x00, 0x06,           // JVB to $0600
};

// Screen memory (message to display)
static const uint8_t screen_text[] = {
    // "  ATARI 800XL EMULATOR  " centered on line 1
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 7 spaces
    0x21, 0x34, 0x21, 0x32, 0x29, // ATARI
    0x00, // space
    0x18, 0x10, 0x10, // 800
    0x38, 0x2C, // XL
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 7 spaces padding
    // Line 2: "    FOR LILYGO T-HMI    "
    0x00, 0x00, 0x00, 0x00, // 4 spaces
    0x26, 0x2F, 0x32, // FOR
    0x00, // space
    0x2C, 0x29, 0x2C, 0x39, 0x27, 0x2F, // LILYGO
    0x00, // space
    0x34, 0x0D, 0x28, 0x2D, 0x29, // T-HMI
    0x00, 0x00, 0x00, 0x00, // 4 spaces
};

// Build the 16KB OS ROM
alignas(4) const uint8_t atarixl_os_rom[ATARIXL_OS_SIZE] = {
    // This will be initialized at compile time
    // Structure:
    // $C000-$CFFF: Floating point (filled with NOPs/RTI)
    // $D000-$D7FF: Self-test (filled with placeholder)
    // $D800-$DFFF: Normally I/O, but shadow charset area
    // $E000-$E3FF: Character set
    // $E400-$FFEF: OS routines
    // $FFF0-$FFFF: Vectors

    // For now, fill with 0xFF (like empty EPROM)
    // The actual initialization happens via the init routines
    [0 ... ATARIXL_OS_SIZE - 1] = 0xFF
};

// Helper function to patch the ROM at runtime (called by emulator init)
// Note: In a real implementation, this would load Altirra OS or original ROM
void initAtariOSRom(uint8_t *rom) {
    // Copy character set to $E000 offset ($2000 from base)
    memcpy(rom + 0x2000, atari_charset, sizeof(atari_charset));

    // Copy boot code to $E450 offset ($2450 from base)
    memcpy(rom + 0x2450, boot_code, sizeof(boot_code));

    // Set up vectors at $FFFA-$FFFF (offset $3FFA from base)
    // NMI vector -> $E450 (VBI handler)
    rom[0x3FFA] = 0x50;
    rom[0x3FFB] = 0xE4;
    // RESET vector -> $E450 (boot routine)
    rom[0x3FFC] = 0x50;
    rom[0x3FFD] = 0xE4;
    // IRQ vector -> $E460 (simple RTI)
    rom[0x3FFE] = 0x60;
    rom[0x3FFF] = 0xE4;

    // RTI at $E460 for IRQ handler
    rom[0x2460] = 0x40; // RTI
}
