<!DOCTYPE html>
<!--
 Atari 800 XL Web Keyboard
 Copyright (C) 2025 <uliuc@gmx.net>

 Based on the great work of Bryan Miner's mac keyboard
 https://codepen.io/gymbry/pen/KWwepx

 This program is free software; you can redistribute it and/or modify it
 under the terms of the GNU General Public License as published by the
 Free Software Foundation; either version 3 of the License, or (at your
 option) any later version.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Atari 800 XL Keyboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 18px;
            user-select: none;
        }

        h2 {
            color: #e0e0e0;
            margin: 18px 0;
            font-size: 32px;
            text-align: center;
        }

        .keyboard-container {
            display: flex;
            gap: 26px;
            align-items: flex-start;
            max-width: 100%;
        }

        .main-keyboard {
            background: #2d2d44;
            padding: 21px;
            border-radius: 18px;
            box-shadow: 0 7px 26px rgba(0,0,0,0.4);
        }

        /* Console keys panel - matches Atari 800 XL right side */
        .console-panel {
            background: #1a1a1a;
            padding: 14px 21px;
            border-radius: 14px;
            box-shadow: 0 7px 26px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .console-row {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        /* Metallic silver button style like real Atari */
        .console-btn {
            width: 77px;
            height: 67px;
            background: linear-gradient(180deg,
                #9a9a9a 0%,
                #808080 20%,
                #707070 50%,
                #606060 80%,
                #505050 100%);
            border: 2px solid #444;
            border-radius: 5px;
            cursor: pointer;
            box-shadow:
                inset 0 2px 0 rgba(255,255,255,0.3),
                inset 0 -2px 0 rgba(0,0,0,0.3),
                0 4px 7px rgba(0,0,0,0.5);
        }

        .console-btn:active, .console-btn.active {
            background: linear-gradient(180deg,
                #707070 0%,
                #606060 20%,
                #505050 50%,
                #454545 80%,
                #404040 100%);
            transform: translateY(2px);
            box-shadow:
                inset 0 2px 0 rgba(255,255,255,0.2),
                inset 0 -2px 0 rgba(0,0,0,0.2),
                0 2px 4px rgba(0,0,0,0.5);
        }

        /* Toggle button held state - golden glow */
        .console-btn.held {
            background: linear-gradient(180deg,
                #b8a030 0%,
                #a08020 20%,
                #907010 50%,
                #806000 80%,
                #705000 100%);
            box-shadow:
                inset 0 2px 0 rgba(255,255,255,0.3),
                inset 0 -2px 0 rgba(0,0,0,0.3),
                0 0 14px rgba(255,200,0,0.6),
                0 4px 7px rgba(0,0,0,0.5);
        }

        .console-label {
            color: #e0e0e0;
            font-size: 19px;
            font-weight: bold;
            letter-spacing: 2px;
            min-width: 96px;
            text-align: left;
        }

        .console-label.held-label {
            color: #ffd700;
        }

        .row {
            display: flex;
            gap: 7px;
            justify-content: center;
            margin-bottom: 7px;
        }

        .key {
            background: linear-gradient(180deg, #4a4a5e 0%, #3a3a4e 100%);
            border: 2px solid #555;
            border-radius: 9px;
            color: #fff;
            font-size: 19px;
            font-weight: bold;
            min-width: 63px;
            height: 63px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 4px 7px rgba(0,0,0,0.3);
        }

        .key:active, .key.active {
            background: linear-gradient(180deg, #6a6a8e 0%, #5a5a7e 100%);
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .key .shift-char {
            font-size: 16px;
            color: #aaa;
        }

        .key .main-char {
            font-size: 21px;
        }

        /* Special key widths */
        .key-esc { min-width: 74px; }
        .key-tab { min-width: 95px; }
        .key-ctrl { min-width: 105px; }
        .key-shift { min-width: 126px; }
        .key-shift-r { min-width: 126px; }
        .key-space { min-width: 350px; }
        .key-return { min-width: 105px; height: 63px; }
        .key-break { min-width: 88px; background: linear-gradient(180deg, #8b4513 0%, #6b3503 100%); }
        .key-caps { min-width: 88px; }
        .key-del { min-width: 105px; font-size: 16px; }

        /* Atari logo/inverse key */
        .key-atari {
            min-width: 74px;
            background: linear-gradient(180deg, #5a5a7e 0%, #4a4a6e 100%);
        }

        .atari-logo {
            width: 28px;
            height: 28px;
            position: relative;
        }

        .atari-logo::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-bottom: 25px solid #fff;
            top: 2px;
            left: 0;
        }

        /* Utility buttons area */
        .util-keys {
            background: #2d2d44;
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 7px 26px rgba(0,0,0,0.4);
            margin-top: 18px;
            display: flex;
            gap: 14px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .util-key {
            background: linear-gradient(180deg, #3a5a3a 0%, #2a4a2a 100%);
            border: 2px solid #4a6a4a;
            border-radius: 9px;
            color: #fff;
            font-size: 19px;
            font-weight: bold;
            min-width: 105px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .util-key:active, .util-key.active {
            background: linear-gradient(180deg, #5a7a5a 0%, #4a6a4a 100%);
        }

        /* Special combo buttons */
        .combo-key {
            background: linear-gradient(180deg, #5a3a5a 0%, #4a2a4a 100%);
            border: 2px solid #6a4a6a;
            min-width: 175px;
            font-size: 18px;
        }

        .combo-key:active, .combo-key.active {
            background: linear-gradient(180deg, #7a5a7a 0%, #6a4a6a 100%);
        }

        /* Help text */
        .help-text {
            color: #888;
            font-size: 19px;
            margin-top: 26px;
            text-align: center;
            max-width: 1225px;
        }

        .help-text ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            justify-content: center;
            margin-top: 14px;
        }

        .help-text li {
            background: #2d2d44;
            padding: 7px 14px;
            border-radius: 7px;
        }

        .help-section {
            margin-top: 18px;
            padding: 14px;
            background: #252540;
            border-radius: 11px;
        }

        .help-section strong {
            color: #ffd700;
        }

        /* Status indicator */
        #status {
            position: fixed;
            top: 9px;
            right: 9px;
            width: 21px;
            height: 21px;
            border-radius: 50%;
            background: #f00;
        }

        #status.connected {
            background: #0f0;
        }

        /* Hold indicator */
        .hold-status {
            position: fixed;
            top: 9px;
            left: 9px;
            color: #ffd700;
            font-size: 19px;
            font-weight: bold;
            display: none;
        }

        .hold-status.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div id="status"></div>
    <div id="holdStatus" class="hold-status">HELD: <span id="heldKeys"></span></div>
    <h2>Atari 800 XL</h2>

    <div class="keyboard-container">
        <div class="main-keyboard">
            <!-- Row 1: Number row -->
            <div class="row">
                <div class="key key-esc" data-key="Escape" data-physical="Escape">ESC</div>
                <div class="key" data-key="1" data-physical="Digit1"><span class="shift-char">!</span><span class="main-char">1</span></div>
                <div class="key" data-key="2" data-physical="Digit2"><span class="shift-char">"</span><span class="main-char">2</span></div>
                <div class="key" data-key="3" data-physical="Digit3"><span class="shift-char">#</span><span class="main-char">3</span></div>
                <div class="key" data-key="4" data-physical="Digit4"><span class="shift-char">$</span><span class="main-char">4</span></div>
                <div class="key" data-key="5" data-physical="Digit5"><span class="shift-char">%</span><span class="main-char">5</span></div>
                <div class="key" data-key="6" data-physical="Digit6"><span class="shift-char">&amp;</span><span class="main-char">6</span></div>
                <div class="key" data-key="7" data-physical="Digit7"><span class="shift-char">'</span><span class="main-char">7</span></div>
                <div class="key" data-key="8" data-physical="Digit8"><span class="shift-char">@</span><span class="main-char">8</span></div>
                <div class="key" data-key="9" data-physical="Digit9"><span class="shift-char">(</span><span class="main-char">9</span></div>
                <div class="key" data-key="0" data-physical="Digit0"><span class="shift-char">)</span><span class="main-char">0</span></div>
                <div class="key" data-key="<" data-physical="Comma"><span class="shift-char">CLR</span><span class="main-char">&lt;</span></div>
                <div class="key" data-key=">" data-physical="Period"><span class="shift-char">INS</span><span class="main-char">&gt;</span></div>
                <div class="key key-del" data-key="Backspace" data-physical="Backspace">BACK S</div>
                <div class="key key-break" data-key="BREAK" data-physical="Pause">BREAK</div>
            </div>

            <!-- Row 2: QWERTY row -->
            <div class="row">
                <div class="key key-tab" data-key="Tab" data-physical="Tab">TAB</div>
                <div class="key" data-key="q" data-physical="KeyQ">Q</div>
                <div class="key" data-key="w" data-physical="KeyW">W</div>
                <div class="key" data-key="e" data-physical="KeyE">E</div>
                <div class="key" data-key="r" data-physical="KeyR">R</div>
                <div class="key" data-key="t" data-physical="KeyT">T</div>
                <div class="key" data-key="y" data-physical="KeyY">Y</div>
                <div class="key" data-key="u" data-physical="KeyU">U</div>
                <div class="key" data-key="i" data-physical="KeyI">I</div>
                <div class="key" data-key="o" data-physical="KeyO">O</div>
                <div class="key" data-key="p" data-physical="KeyP">P</div>
                <div class="key" data-key="-" data-physical="Minus"><span class="shift-char">_</span><span class="main-char">-</span></div>
                <div class="key" data-key="=" data-physical="Equal"><span class="shift-char">|</span><span class="main-char">=</span></div>
                <div class="key key-return" data-key="Enter" data-physical="Enter">RETURN</div>
            </div>

            <!-- Row 3: ASDF row -->
            <div class="row">
                <div class="key key-ctrl" data-key="Control" data-modifier="ctrl" data-physical="ControlLeft">CTRL</div>
                <div class="key" data-key="a" data-physical="KeyA">A</div>
                <div class="key" data-key="s" data-physical="KeyS">S</div>
                <div class="key" data-key="d" data-physical="KeyD">D</div>
                <div class="key" data-key="f" data-physical="KeyF">F</div>
                <div class="key" data-key="g" data-physical="KeyG">G</div>
                <div class="key" data-key="h" data-physical="KeyH">H</div>
                <div class="key" data-key="j" data-physical="KeyJ">J</div>
                <div class="key" data-key="k" data-physical="KeyK">K</div>
                <div class="key" data-key="l" data-physical="KeyL">L</div>
                <div class="key" data-key=";" data-physical="Semicolon"><span class="shift-char">:</span><span class="main-char">;</span></div>
                <div class="key" data-key="+" data-physical="Equal"><span class="shift-char">\</span><span class="main-char">+</span></div>
                <div class="key" data-key="*" data-physical="Digit8"><span class="shift-char">^</span><span class="main-char">*</span></div>
                <div class="key key-caps" data-key="Capslock" data-physical="CapsLock">CAPS</div>
            </div>

            <!-- Row 4: ZXCV row -->
            <div class="row">
                <div class="key key-shift" data-key="Shift" data-modifier="shift" data-physical="ShiftLeft">SHIFT</div>
                <div class="key" data-key="z" data-physical="KeyZ">Z</div>
                <div class="key" data-key="x" data-physical="KeyX">X</div>
                <div class="key" data-key="c" data-physical="KeyC">C</div>
                <div class="key" data-key="v" data-physical="KeyV">V</div>
                <div class="key" data-key="b" data-physical="KeyB">B</div>
                <div class="key" data-key="n" data-physical="KeyN">N</div>
                <div class="key" data-key="m" data-physical="KeyM">M</div>
                <div class="key" data-key="," data-physical="Comma"><span class="shift-char">[</span><span class="main-char">,</span></div>
                <div class="key" data-key="." data-physical="Period"><span class="shift-char">]</span><span class="main-char">.</span></div>
                <div class="key" data-key="/" data-physical="Slash"><span class="shift-char">?</span><span class="main-char">/</span></div>
                <div class="key key-atari" data-key="INVERSE" data-physical="Insert"><div class="atari-logo"></div></div>
                <div class="key key-shift-r" data-key="Shift" data-modifier="shift" data-physical="ShiftRight">SHIFT</div>
            </div>

            <!-- Row 5: Space bar -->
            <div class="row">
                <div class="key key-space" data-key=" " data-physical="Space">SPACE</div>
            </div>
        </div>

        <!-- Console keys panel - like real Atari 800 XL -->
        <div class="console-panel">
            <div class="console-row">
                <div class="console-btn" data-key="RESET"></div>
                <span class="console-label">RESET</span>
            </div>
            <div class="console-row">
                <div class="console-btn" data-key="OPTION" data-toggle="true"></div>
                <span class="console-label" id="labelOPTION">OPTION</span>
            </div>
            <div class="console-row">
                <div class="console-btn" data-key="SELECT"></div>
                <span class="console-label">SELECT</span>
            </div>
            <div class="console-row">
                <div class="console-btn" data-key="START" data-toggle="true"></div>
                <span class="console-label" id="labelSTART">START</span>
            </div>
            <div class="console-row">
                <div class="console-btn" data-key="Help"></div>
                <span class="console-label">HELP</span>
            </div>
        </div>
    </div>

    <!-- Utility buttons -->
    <div class="util-keys">
        <div class="util-key" data-key="LOAD">LOAD</div>
        <div class="util-key" data-key="SAVE">SAVE</div>
        <div class="util-key combo-key" data-combo="coldboot" title="Cold boot with OPTION held (skip BASIC)">COLD BOOT</div>
        <div class="util-key combo-key" data-combo="cassette" title="Cassette load mode (START+OPTION+RESET)">CASSETTE</div>
        <div class="util-key combo-key" data-combo="selftest" title="Enter self-test diagnostics">SELF-TEST</div>
    </div>

    <div class="help-text">
        <div class="help-section">
            <strong>Toggle:</strong> Click OPTION/START to hold (gold). Click RESET for boot combos.
        </div>
    </div>

    <script>
        // Optimized for low latency with minimum key hold time
        let ws;
        let mod = 0; // Bitmask: 1=shift, 2=ctrl
        let held = {}; // Toggle keys

        // Track key press times - ensures emulator sees key for at least MIN_HOLD_MS
        const keyDownTime = {};
        const pendingKeyUp = {};
        const MIN_HOLD_MS = 50; // Minimum time key must be held (â‰ˆ3 frames at 60fps)

        // Pre-build key map at load time
        const keyMap = {};

        function init() {
            document.querySelectorAll('.key, .console-btn').forEach(el => {
                const p = el.dataset.physical;
                if (p) keyMap[p] = el;
                const k = el.dataset.key;
                if (k) keyMap[k.toLowerCase()] = el;
            });
        }

        function connect() {
            const p = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${p}//${location.host}/ws`);
            ws.onopen = () => document.getElementById('status').className = 'connected';
            ws.onclose = () => { document.getElementById('status').className = ''; setTimeout(connect, 2000); };
        }

        // Minimal JSON for speed: {"t":"d","k":"a","m":0}
        // t = type (d=down, u=up), k = key, m = modifiers bitmask
        function send(type, key) {
            if (ws && ws.readyState === 1) {
                ws.send(`{"t":"${type}","k":"${key}","m":${mod}}`);
            }
        }

        function updateHeld() {
            const names = Object.keys(held).filter(k => held[k]);
            const el = document.getElementById('holdStatus');
            if (names.length) {
                document.getElementById('heldKeys').textContent = names.join('+');
                el.className = 'hold-status visible';
            } else {
                el.className = 'hold-status';
            }
        }

        function keyDown(el) {
            const k = el.dataset.key;
            const m = el.dataset.modifier;
            const tog = el.dataset.toggle === 'true';

            if (tog) {
                if (held[k]) {
                    held[k] = false;
                    el.classList.remove('held');
                    const lbl = document.getElementById('label' + k);
                    if (lbl) lbl.classList.remove('held-label');
                    send('u', k);
                } else {
                    held[k] = true;
                    el.classList.add('held');
                    const lbl = document.getElementById('label' + k);
                    if (lbl) lbl.classList.add('held-label');
                    send('d', k);
                }
                updateHeld();
                return;
            }

            // Cancel any pending key-up for this key
            if (pendingKeyUp[k]) {
                clearTimeout(pendingKeyUp[k]);
                delete pendingKeyUp[k];
            }

            el.classList.add('active');
            if (m === 'shift') { mod |= 1; return; }
            if (m === 'ctrl') { mod |= 2; return; }

            keyDownTime[k] = Date.now();
            send('d', k);
        }

        function keyUp(el) {
            const k = el.dataset.key;
            const m = el.dataset.modifier;
            if (el.dataset.toggle === 'true') return;

            el.classList.remove('active');
            if (m === 'shift') { mod &= ~1; return; }
            if (m === 'ctrl') { mod &= ~2; return; }

            // Ensure minimum hold time so emulator sees the key
            const downTime = keyDownTime[k] || 0;
            const elapsed = Date.now() - downTime;
            const remaining = MIN_HOLD_MS - elapsed;

            if (remaining > 0) {
                // Delay key-up to meet minimum hold time
                pendingKeyUp[k] = setTimeout(() => {
                    send('u', k);
                    delete pendingKeyUp[k];
                    delete keyDownTime[k];
                }, remaining);
            } else {
                send('u', k);
                delete keyDownTime[k];
            }
        }

        function combo(c) {
            if (c === 'coldboot') {
                send('d', 'OPTION');
                setTimeout(() => { send('d', 'RESET'); setTimeout(() => { send('u', 'RESET'); setTimeout(() => send('u', 'OPTION'), 50); }, 100); }, 50);
            } else if (c === 'cassette') {
                send('d', 'START'); send('d', 'OPTION');
                setTimeout(() => {
                    send('d', 'RESET');
                    setTimeout(() => {
                        send('u', 'RESET');
                        held['START'] = held['OPTION'] = true;
                        document.querySelector('[data-key="START"]').classList.add('held');
                        document.querySelector('[data-key="OPTION"]').classList.add('held');
                        const ls = document.getElementById('labelSTART'), lo = document.getElementById('labelOPTION');
                        if (ls) ls.classList.add('held-label');
                        if (lo) lo.classList.add('held-label');
                        updateHeld();
                    }, 100);
                }, 50);
            } else if (c === 'selftest') {
                send('d', 'START'); send('d', 'OPTION');
                setTimeout(() => { send('d', 'RESET'); setTimeout(() => { send('u', 'RESET'); setTimeout(() => { send('u', 'START'); send('u', 'OPTION'); }, 50); }, 100); }, 50);
            }
        }

        // Event setup
        document.querySelectorAll('.key, .console-btn, .util-key').forEach(el => {
            if (el.dataset.combo) {
                el.onclick = e => { e.preventDefault(); el.classList.add('active'); combo(el.dataset.combo); setTimeout(() => el.classList.remove('active'), 200); };
                return;
            }
            el.onmousedown = el.ontouchstart = e => { e.preventDefault(); keyDown(el); };
            el.onmouseup = el.ontouchend = e => { e.preventDefault(); keyUp(el); };
            el.onmouseleave = () => { if (el.classList.contains('active') && !el.dataset.toggle) keyUp(el); };
        });

        // Physical keyboard with minimum hold time
        document.onkeydown = e => {
            if (e.repeat) return;
            e.preventDefault();

            let k = e.key;
            const web = keyMap[e.code] || keyMap[k.toLowerCase()];
            if (web && !web.dataset.toggle) web.classList.add('active');

            if (k === 'Control') { mod |= 2; return; }
            if (k === 'Shift') { mod |= 1; return; }

            // Function key mappings
            if (k === 'F1') k = 'OPTION';
            else if (k === 'F2') k = 'SELECT';
            else if (k === 'F3') k = 'START';
            else if (k === 'F4') k = 'RESET';
            else if (k === 'F5') k = 'Help';
            else if (k === 'Insert') k = 'INVERSE';
            else if (k === 'Pause') k = 'BREAK';

            // Cancel any pending key-up
            if (pendingKeyUp[k]) {
                clearTimeout(pendingKeyUp[k]);
                delete pendingKeyUp[k];
            }

            keyDownTime[k] = Date.now();
            send('d', k);
        };

        document.onkeyup = e => {
            e.preventDefault();

            let k = e.key;
            const web = keyMap[e.code] || keyMap[k.toLowerCase()];
            if (web && !web.dataset.toggle) web.classList.remove('active');

            if (k === 'Control') { mod &= ~2; return; }
            if (k === 'Shift') { mod &= ~1; return; }

            if (k === 'F1') k = 'OPTION';
            else if (k === 'F2') k = 'SELECT';
            else if (k === 'F3') k = 'START';
            else if (k === 'F4') k = 'RESET';
            else if (k === 'F5') k = 'Help';
            else if (k === 'Insert') k = 'INVERSE';
            else if (k === 'Pause') k = 'BREAK';

            // Ensure minimum hold time
            const downTime = keyDownTime[k] || 0;
            const elapsed = Date.now() - downTime;
            const remaining = MIN_HOLD_MS - elapsed;

            if (remaining > 0) {
                pendingKeyUp[k] = setTimeout(() => {
                    send('u', k);
                    delete pendingKeyUp[k];
                    delete keyDownTime[k];
                }, remaining);
            } else {
                send('u', k);
                delete keyDownTime[k];
            }
        };

        init();
        connect();
    </script>
</body>
</html>
